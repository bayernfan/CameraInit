#include "lcd.h"

#define TTY_ROW_GAP 4

#define TTY_COL_GAP 1

#define TTY_ROW_HEIGHT (ASCII_HEIGHT + TTY_ROW_GAP)

#define TTY_COL_WIDTH (ASCII_WIDTH + TTY_COL_GAP)

#define TTY_N_ROWS ((LCD_width + TTY_ROW_GAP) / TTY_ROW_HEIGHT)

#define TTY_N_COLS ((LCD_height + TTY_COL_GAP) / TTY_COL_WIDTH)

#define ASC_OF(N) ((N) > 32 && (N) < 127 ? ASCII[(N) - 32] : ASCII[0])

#define TTY_eraseAll() LCD_fillScreen(backColor_cache)

#define TTY_writeASCII(i_row, i_col, ch, color) \
     LCD_writeASCII((i_col) * TTY_COL_WIDTH, LCD_width - \
     (i_row) * TTY_ROW_HEIGHT - ASCII_HEIGHT, (ch), (color))

static uint16_t volatile ASCII_row = 0;

static uint16_t volatile ASCII_col = 0;

static uint16_t volatile backColor_cache = BLACK;

static void TTY_eraseRow(uint16_t i_row);

static uint8_t const ASCII[][ASCII_WIDTH] = {
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, // 32 = (space)
    { 0x00, 0x00, 0x5F, 0x00, 0x00 }, // 33 = !
    { 0x00, 0x03, 0x00, 0x03, 0x00 }, // 34 = "
    { 0x14, 0x3E, 0x14, 0x3E, 0x14 }, // 35 = #
    { 0x26, 0x49, 0xFF, 0x49, 0x32 }, // 36 = $
    { 0x23, 0x13, 0x08, 0x64, 0x62 }, // 37 = %
    { 0x36, 0x59, 0x55, 0x22, 0x50 }, // 38 = &
    { 0x00, 0x00, 0x03, 0x00, 0x00 }, // 39 = '
    { 0x00, 0x1C, 0x22, 0x41, 0x00 }, // 40 = (
    { 0x00, 0x41, 0x22, 0x1C, 0x00 }, // 41 = )
    { 0x14, 0x08, 0x3E, 0x08, 0x14 }, // 42 = *
    { 0x08, 0x08, 0x3E, 0x08, 0x08 }, // 43 = +
    { 0x00, 0x40, 0x20, 0x00, 0x00 }, // 44 = ,
    { 0x08, 0x08, 0x08, 0x08, 0x08 }, // 45 = -
    { 0x00, 0x00, 0x20, 0x00, 0x00 }, // 46 = .
    { 0x20, 0x10, 0x08, 0x04, 0x02 }, // 47 = /
    { 0x3E, 0x45, 0x49, 0x51, 0x3E }, // 48 = 0
    { 0x00, 0x42, 0x7F, 0x40, 0x00 }, // 49 = 1
    { 0x46, 0x61, 0x51, 0x49, 0x46 }, // 50 = 2
    { 0x22, 0x49, 0x49, 0x49, 0x36 }, // 51 = 3
    { 0x18, 0x14, 0x12, 0x7F, 0x10 }, // 52 = 4
    { 0x2E, 0x49, 0x49, 0x49, 0x30 }, // 53 = 5
    { 0x3E, 0x49, 0x49, 0x49, 0x32 }, // 54 = 6
    { 0x01, 0x01, 0x71, 0x0D, 0x03 }, // 55 = 7
    { 0x36, 0x49, 0x49, 0x49, 0x36 }, // 56 = 8
    { 0x26, 0x49, 0x49, 0x49, 0x3E }, // 57 = 9
    { 0x00, 0x00, 0x24, 0x00, 0x00 }, // 58 = :
    { 0x00, 0x40, 0x24, 0x00, 0x00 }, // 59 = ;
    { 0x00, 0x08, 0x14, 0x22, 0x00 }, // 60 = <
    { 0x00, 0x14, 0x14, 0x14, 0x00 }, // 61 = =
    { 0x00, 0x22, 0x14, 0x08, 0x00 }, // 62 = >
    { 0x02, 0x01, 0x51, 0x09, 0x06 }, // 63 = ?
    { 0x3E, 0x41, 0x5D, 0x15, 0x2A }, // 64 = @
    { 0x7C, 0x12, 0x11, 0x12, 0x7C }, // 65 = A
    { 0x7F, 0x49, 0x49, 0x49, 0x36 }, // 66 = B
    { 0x3E, 0x41, 0x41, 0x41, 0x22 }, // 67 = C
    { 0x7F, 0x41, 0x41, 0x41, 0x3E }, // 68 = D
    { 0x7F, 0x49, 0x49, 0x49, 0x41 }, // 69 = E
    { 0x7F, 0x09, 0x09, 0x09, 0x01 }, // 70 = F
    { 0x3E, 0x41, 0x49, 0x49, 0x7A }, // 71 = G
    { 0x7F, 0x08, 0x08, 0x08, 0x7F }, // 72 = H
    { 0x00, 0x41, 0x7F, 0x41, 0x00 }, // 73 = I
    { 0x20, 0x40, 0x41, 0x3F, 0x01 }, // 74 = J
    { 0x7F, 0x08, 0x14, 0x22, 0x41 }, // 75 = K
    { 0x7F, 0x40, 0x40, 0x40, 0x40 }, // 76 = L
    { 0x7F, 0x02, 0x04, 0x02, 0x7F }, // 77 = M
    { 0x7F, 0x02, 0x04, 0x08, 0x7F }, // 78 = N
    { 0x3E, 0x41, 0x41, 0x41, 0x3E }, // 79 = O
    { 0x7F, 0x09, 0x09, 0x09, 0x06 }, // 80 = P
    { 0x3E, 0x41, 0x61, 0x41, 0xBE }, // 81 = Q
    { 0x7F, 0x09, 0x19, 0x29, 0x46 }, // 82 = R
    { 0x26, 0x49, 0x49, 0x49, 0x32 }, // 83 = S
    { 0x01, 0x01, 0x7F, 0x01, 0x01 }, // 84 = T
    { 0x3F, 0x40, 0x40, 0x40, 0x3F }, // 85 = U
    { 0x07, 0x18, 0x60, 0x18, 0x07 }, // 86 = V
    { 0x7F, 0x20, 0x10, 0x20, 0x7F }, // 87 = W
    { 0x63, 0x14, 0x08, 0x14, 0x63 }, // 88 = X
    { 0x03, 0x0C, 0x70, 0x0C, 0x03 }, // 89 = Y
    { 0x61, 0x51, 0x49, 0x45, 0x43 }, // 90 = Z
    { 0x00, 0x7F, 0x41, 0x41, 0x00 }, // 91 = [
    { 0x02, 0x04, 0x08, 0x10, 0x20 }, // 92 = (back slash)
    { 0x00, 0x41, 0x41, 0x7F, 0x00 }, // 93 = ]
    { 0x00, 0x02, 0x01, 0x02, 0x00 }, // 94 = ^
    { 0x40, 0x40, 0x40, 0x40, 0x40 }, // 95 = _
    { 0x00, 0x01, 0x02, 0x04, 0x00 }, // 96 = `
    { 0x20, 0x54, 0x54, 0x38, 0x40 }, // 97 = a
    { 0x00, 0x7F, 0x48, 0x48, 0x30 }, // 98 = b
    { 0x38, 0x44, 0x44, 0x44, 0x08 }, // 99 = c
    { 0x30, 0x48, 0x48, 0x7F, 0x00 }, // 100 = d
    { 0x38, 0x54, 0x54, 0x54, 0x18 }, // 101 = e
    { 0x08, 0x7E, 0x09, 0x09, 0x00 }, // 102 = f
    { 0x18, 0xA4, 0xA4, 0x7C, 0x00 }, // 103 = g
    { 0x00, 0x7F, 0x04, 0x04, 0x78 }, // 104 = h
    { 0x00, 0x00, 0x7A, 0x00, 0x00 }, // 105 = i
    { 0x00, 0x80, 0x80, 0x7A, 0x00 }, // 106 = j
    { 0x00, 0x7F, 0x10, 0x28, 0x44 }, // 107 = k
    { 0x00, 0x00, 0x7F, 0x00, 0x00 }, // 108 = l
    { 0x7C, 0x04, 0x78, 0x04, 0x78 }, // 109 = m
    { 0x00, 0x7C, 0x04, 0x04, 0x78 }, // 110 = n
    { 0x38, 0x44, 0x44, 0x44, 0x38 }, // 111 = o
    { 0x00, 0xFC, 0x24, 0x24, 0x18 }, // 112 = p
    { 0x18, 0x24, 0x24, 0xFC, 0x00 }, // 113 = q
    { 0x00, 0x7C, 0x08, 0x04, 0x04 }, // 114 = r
    { 0x08, 0x54, 0x54, 0x54, 0x20 }, // 115 = s
    { 0x04, 0x3E, 0x44, 0x44, 0x00 }, // 116 = t
    { 0x3C, 0x40, 0x40, 0x7C, 0x00 }, // 117 = u
    { 0x0C, 0x30, 0x40, 0x30, 0x0C }, // 118 = v
    { 0x3C, 0x40, 0x38, 0x40, 0x3C }, // 119 = w
    { 0x44, 0x28, 0x10, 0x28, 0x44 }, // 120 = x
    { 0x04, 0x88, 0x50, 0x30, 0x0C }, // 121 = y
    { 0x40, 0x64, 0x54, 0x4C, 0x04 }, // 122 = z
    { 0x00, 0x08, 0x36, 0x41, 0x00 }, // 123 = {
    { 0x00, 0x00, 0x7F, 0x00, 0x00 }, // 124 = |
    { 0x00, 0x41, 0x36, 0x08, 0x00 }, // 125 = }
    { 0x08, 0x04, 0x08, 0x10, 0x08 } // 126 = ~
};

void TTY_printChar(uint8_t ch, uint16_t color) {
    if ('\n' == ch) {
        if (++ASCII_row == TTY_N_ROWS) {
            TTY_eraseAll();
            ASCII_row = 0;
        } else {
            TTY_eraseRow(ASCII_row);
        }
        ASCII_col = 0;
        return;
    }
    
    TTY_writeASCII(ASCII_row, ASCII_col, ch, color);
    
    if (++ASCII_col == TTY_N_COLS) {
        TTY_printChar('\n', color);
    }
}

void TTY_printString(char const *str, uint16_t color) {
    while (*str) TTY_printChar(*str++, color);
}

void TTY_eraseRow(uint16_t i_row) {
    uint16_t i_col;
    for (i_col = 0; i_col < TTY_N_COLS; i_col++)
        TTY_writeASCII(i_row, i_col, ' ', backColor_cache);
}


void LCD_writeASCII(uint16_t x0, uint16_t y0, uint8_t ch, uint16_t color) {
    static uint16_t volatile colors[ASCII_WIDTH * ASCII_HEIGHT];
    
    int i, j;
    uint8_t const* ascii = ASC_OF(ch);
    for (i = 0; i < ASCII_WIDTH; i++) {
        for (j = 0; j < ASCII_HEIGHT; j++) {
            colors[i * ASCII_HEIGHT + j] = (ascii[i] >> (ASCII_HEIGHT - 1 - j)) & 0x01 ? color : backColor_cache;
        }
    }
    
    LCD_setAddrWindow(x0, y0, x0 + ASCII_WIDTH - 1, y0 + ASCII_HEIGHT - 1);    
    LCD_pushColor((uint16_t *)colors, ASCII_WIDTH * ASCII_HEIGHT);
}

void LCD_fillScreen(uint16_t color) {
    static uint16_t volatile colors[LCD_width];
    uint16_t volatile i;
    
    if (backColor_cache == color) {
        i = 0;
    } else {
        backColor_cache = color;   
        i = LCD_width;
        while (i != 0)
            colors[--i] = color;
    }
    
    LCD_setAddrWindow(0, 0, LCD_height, LCD_width);
    while (i++ < LCD_height)
        LCD_pushColor((uint16_t *)colors, LCD_width);
}
